name: Release - WCF Relay

on:
  push:
    tags:
      - 'wcf-v*'  # Triggers on tags like wcf-v1.3.0, wcf-v1.4.0, etc.

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2
      
      - name: Restore NuGet packages
        run: nuget restore Src/dotnet/RelayTunnelUsingWCF/RelayTunnelUsingWCF.csproj -PackagesDirectory Src/dotnet/packages
      
      - name: Build project
        run: msbuild Src/dotnet/RelayTunnelUsingWCF/RelayTunnelUsingWCF.csproj /p:Configuration=Release /p:OutputPath=..\..\..\publish-wcf
      
      - name: Install Gitleaks (Secret Scanner)
        run: |
          Invoke-WebRequest -Uri "https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_windows_x64.zip" -OutFile gitleaks.zip
          Expand-Archive -Path gitleaks.zip -DestinationPath ./gitleaks
          
      - name: Scan for secrets in build output
        run: |
          ./gitleaks/gitleaks.exe detect --source ./publish-wcf --verbose --no-git
        continue-on-error: false  # Fail the build if secrets are found
      
      - name: Get version from tag
        id: get_version
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^wcf-v', 'v'
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Create ZIP archive
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          Compress-Archive -Path ./publish-wcf/* -DestinationPath "AzureRelayTunnelingUtility-WCF-$version-Win-x86.zip"
        shell: pwsh
      
      - name: Generate release notes
        id: release_notes
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $tag = "${{ steps.get_version.outputs.TAG }}"
          
          $notes = "**WCF Relay (.NET Framework 4.8) - Legacy**`n`n"
          $notes += "‚ö†Ô∏è **Security Warning:** Uses deprecated Azure libraries. Use Hybrid Connection version for production.`n`n"
          $notes += "Download the zip below, extract, rename ``appsettings-template.json`` to ``appsettings.json``, and configure.`n`n"
          $notes += "üìñ [Documentation](https://github.com/${{ github.repository }}/tree/main/Src/dotnet/RelayTunnelUsingWCF)`n`n"
          $notes += "<details>`n<summary>What's Changed</summary>`n`n"
          $notes += "See [full changelog](https://github.com/${{ github.repository }}/commits/$tag)`n`n"
          $notes += "</details>"
          
          echo "NOTES<<EOF" >> $env:GITHUB_OUTPUT
          echo $notes >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: AzureRelayTunnelingUtility-WCF-${{ steps.get_version.outputs.VERSION }}-Win-x86.zip
          body: ${{ steps.release_notes.outputs.NOTES }}
          draft: false
          prerelease: false
          name: "Relay Tunnel Using WCF ${{ steps.get_version.outputs.VERSION }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
