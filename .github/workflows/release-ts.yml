name: Release - TypeScript/Node.js

on:
  push:
    tags:
      - 'ts-v*'  # Triggers on tags like ts-v0.9.0-beta.1, ts-v1.0.0, etc.

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: Win-x64
            pkg_script: pkg:win
            executable: RelayTunnelUsingHybridConnection.exe
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Install dependencies
        run: npm ci
        working-directory: Src/ts/RelayTunnelUsingHybridConnection
      
      - name: Run tests
        run: npm test
        working-directory: Src/ts/RelayTunnelUsingHybridConnection
      
      - name: Package binary for platform
        run: npm run ${{ matrix.pkg_script }}
        working-directory: Src/ts/RelayTunnelUsingHybridConnection
      
      - name: Install Gitleaks (Secret Scanner)
        run: |
          Invoke-WebRequest -Uri "https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_windows_x64.zip" -OutFile gitleaks.zip
          Expand-Archive -Path gitleaks.zip -DestinationPath ./gitleaks
      
      - name: Scan for secrets in build output
        run: |
          ./gitleaks/gitleaks.exe detect --source Src/ts/RelayTunnelUsingHybridConnection/bin --verbose --no-git
        continue-on-error: false
      
      - name: Get version from tag
        id: get_version
        run: |
          tag="${{ github.ref_name }}"
          version="${tag#ts-v}"
          echo "VERSION=v$version" >> $GITHUB_OUTPUT
          echo "TAG=$tag" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Create ZIP archive
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          cd Src/ts/RelayTunnelUsingHybridConnection/bin
          Compress-Archive -Path * -DestinationPath "../../../../RelayTunnel-HC-TS-$version-${{ matrix.platform }}.zip"
        shell: pwsh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: RelayTunnel-HC-TS-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform }}.zip
  
  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: |
          tag="${{ github.ref_name }}"
          version="${tag#ts-v}"
          echo "VERSION=v$version" >> $GITHUB_OUTPUT
          echo "TAG=$tag" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Generate release notes
        id: release_notes
        run: |
          version="${{ steps.get_version.outputs.VERSION }}"
          tag="${{ steps.get_version.outputs.TAG }}"
          
          # Check if beta version
          if [[ "$version" == *"beta"* ]]; then
            prerelease_warning="‚ö†Ô∏è **BETA VERSION - Known Issues with DirectLine/Web Chat**\n\n"
            prerelease_warning+="This TypeScript implementation has known issues when connecting to DirectLine clients:\n"
            prerelease_warning+="- Messages may fail (502 Bad Gateway) or be delayed by several seconds\n"
            prerelease_warning+="- Conversation update activities fail to be received\n"
            prerelease_warning+="- WebSocket mode produces 502 errors even on successful messages (can be safely ignored)\n"
            prerelease_warning+="- **For production DirectLine/Web Chat use, please use the .NET version**\n\n"
          else
            prerelease_warning=""
          fi
          
          notes="${prerelease_warning}**Azure Relay Hybrid Connections (TypeScript/Node.js)**\n\n"
          notes+="**Platform Support:**\n"
          notes+="- Windows (x64) - \`RelayTunnelUsingHybridConnection.exe\`\n\n"
          notes+="Download the zip below, extract, copy \`.env.template\` to \`.env\`, and configure.\n\n"
          notes+="üìñ [Documentation](https://github.com/${{ github.repository }}/tree/main/Src/ts/RelayTunnelUsingHybridConnection)\n\n"
          notes+="<details>\n<summary>What's Changed</summary>\n\n"
          notes+="See [full changelog](https://github.com/${{ github.repository }}/commits/$tag)\n\n"
          notes+="</details>"
          
          echo "NOTES<<EOF" >> $GITHUB_OUTPUT
          echo -e "$notes" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Check if prerelease
        id: check_prerelease
        run: |
          version="${{ steps.get_version.outputs.VERSION }}"
          if [[ "$version" == *"beta"* ]] || [[ "$version" == *"alpha"* ]] || [[ "$version" == *"rc"* ]]; then
            echo "PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi
        shell: bash
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/release-*/*.zip
          body: ${{ steps.release_notes.outputs.NOTES }}
          draft: false
          prerelease: ${{ steps.check_prerelease.outputs.PRERELEASE }}
          name: "Relay Tunnel Using Hybrid Connection (TypeScript) ${{ steps.get_version.outputs.VERSION }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
